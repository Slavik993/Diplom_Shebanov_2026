--- a/Assets/LLMUnity/Runtime/LLMCharacter.cs
+++ b/Assets/LLMUnity/Runtime/LLMCharacter.cs
@@ -268,11 +268,34 @@
         protected virtual async Task<bool> InitNKeep()
         {
-            if (setNKeepToPrompt && nKeep == -1)
-            {
-                if (!CheckTemplate()) return false;
-                string systemPrompt = template.ComputePrompt(new List<ChatMessage>(){chat[0]}, playerName, "", false);
-                List<int> tokens = await Tokenize(systemPrompt);
-                if (tokens == null) return false;
-                SetNKeep(tokens);
-            }
-            return true;
+            try
+            {
+                if (setNKeepToPrompt && nKeep == -1)
+                {
+                    if (!CheckTemplate()) return false;
+
+                    // Подстраховка: если список chat пуст — создаём системное сообщение
+                    if (chat == null || chat.Count == 0)
+                    {
+                        Debug.LogWarning("[LLMCharacter.InitNKeep] Chat list was empty, creating default system message.");
+                        chat = new List<ChatMessage> { new ChatMessage { role = "system", content = prompt ?? "" } };
+                    }
+
+                    string systemPrompt = template.ComputePrompt(new List<ChatMessage>() { chat[0] }, playerName, "", false);
+                    List<int> tokens = await Tokenize(systemPrompt);
+
+                    if (tokens == null || tokens.Count == 0)
+                    {
+                        Debug.LogWarning("[LLMCharacter.InitNKeep] Tokenize() returned empty list.");
+                        return false;
+                    }
+
+                    SetNKeep(tokens);
+                }
+                return true;
+            }
+            catch (ArgumentOutOfRangeException ex)
+            {
+                Debug.LogError("[LLMCharacter.InitNKeep] Caught ArgumentOutOfRangeException: " + ex.Message);
+                nKeep = 0; // безопасное значение
+                return false;
+            }
         }
