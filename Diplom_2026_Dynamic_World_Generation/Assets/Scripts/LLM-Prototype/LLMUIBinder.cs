using UnityEngine;
using TMPro;
using UnityEngine.UI;

public class LLMUIBinder : MonoBehaviour
{
    public UIDynamicBuilder builder;
    public LLMPrototypeController controller;

    void Start()
    {
        builder = FindObjectOfType<UIDynamicBuilder>();
        controller = FindObjectOfType<LLMPrototypeController>();

        if (builder == null || controller == null)
        {
            Debug.LogError("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω UIDynamicBuilder –∏–ª–∏ LLMPrototypeController!");
            return;
        }

        builder.npcGenerateButton.onClick.AddListener(OnGenerateClicked);
    }

    public void OnStoryGenerateClicked()
{
    string theme = builder.storyThemeField.text;
    string style = builder.storyStyleDropdown.options[builder.storyStyleDropdown.value].text;
    string length = builder.storyLengthField.text;

    string prompt = $"–°–æ–∑–¥–∞–π {style} –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ —Ç–µ–º—É '{theme}', –ø—Ä–∏–º–µ—Ä–Ω–æ {length} —Å–ª–æ–≤.";
    builder.storyOutputText.text = "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏...";

    // –í—ã–∑–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ LLM
    string story = controller.GenerateStory(prompt);
    builder.storyOutputText.text = story;
}

    public void OnIconGenerateClicked()
{
    string desc = builder.iconDescriptionField.text;
    string style = builder.iconStyleDropdown.options[builder.iconStyleDropdown.value].text;
    string size = builder.iconSizeField.text;

    builder.iconStatusText.text = "‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∫–æ–Ω–∫–∏...";

    bool success = controller.GenerateIcon(desc, style, size);
    builder.iconStatusText.text = success ? "‚úÖ –ò–∫–æ–Ω–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!" : "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏";
}

    void OnGenerateClicked()
    {
        string name = builder.npcNameField.text;
        string environment = builder.npcEnvironmentField.text; // üÜï
        string relation = builder.npcRelationDropdown.options[builder.npcRelationDropdown.value].text;
        string emotion = builder.npcEmotionDropdown.options[builder.npcEmotionDropdown.value].text;
        string reaction = builder.npcReactionField.text;

        // –°–æ–∑–¥–∞—ë–º JSON –∏–∑ –¥–∞–Ω–Ω—ã—Ö UI
        string inputJson = $@"{{
    ""playerAction"": ""refuse"",
    ""npcState"": ""{relation}"",
    ""context"": {{
        ""location"": ""{environment}"",
        ""relationship"": ""{relation}""
    }},
    ""emotion"": ""{emotion}"",
    ""reactionLevel"": {reaction}
}}";

        Debug.Log($"[LLMUIBinder] –û—Ç–ø—Ä–∞–≤–ª—è–µ–º JSON –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä:\n{inputJson}");

        string dialogue = controller.GenerateDialogueFromJSON(inputJson);
        builder.npcDialogueText.text = dialogue;
    }
}
