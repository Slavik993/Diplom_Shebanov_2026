using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System;
using System.IO;

public class LLMUIBinder : MonoBehaviour
{
    [Header("–û—Å–Ω–æ–≤–Ω—ã–µ —Å–≤—è–∑–∏")]
    public UIDynamicBuilder builder;
    public LLMPrototypeController controller;

    // === –°–æ–±—ã—Ç–∏—è ===
    public Action<string> onGenerateDialogue; // NPC
    public Action<string> onGenerateStory;    // –°–∫–∞–∑–∏—Ç–µ–ª—å –∏—Å—Ç–æ—Ä–∏–π
    public Action<string> onGenerateIcon;     // –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∫–æ–Ω

    void Start()
    {
        if (builder == null) builder = FindObjectOfType<UIDynamicBuilder>();
        if (controller == null) controller = FindObjectOfType<LLMPrototypeController>();

        if (builder == null || controller == null)
        {
            Debug.LogError("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω UIDynamicBuilder –∏–ª–∏ LLMPrototypeController!");
            return;
        }

        BindUI();
    }

    public void ShowLoading(string message = "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...")
    {
        if (builder.loadingPanel != null)
        {
            builder.loadingPanel.SetActive(true);
            if (builder.loadingText != null)
                builder.loadingText.text = message;
        }
    }

    public void HideLoading()
    {
        if (builder.loadingPanel != null)
            builder.loadingPanel.SetActive(false);
    }


    public void BindUI()
    {
        // --- NPC ---
        if (builder.npcGenerateButton != null)
            builder.npcGenerateButton.onClick.AddListener(OnGenerateDialogueClicked);

        if (builder.npcSaveButton != null)
            builder.npcSaveButton.onClick.AddListener(SaveNPCDialogue);

        // --- StoryTeller ---
        if (builder.storyGenerateButton != null)
            builder.storyGenerateButton.onClick.AddListener(OnGenerateStoryClicked);

        if (builder.storySaveButton != null)
            builder.storySaveButton.onClick.AddListener(SaveStory);

        // --- Icon Generator ---
        if (builder.iconGenerateButton != null)
            builder.iconGenerateButton.onClick.AddListener(OnGenerateIconClicked);

        if (builder.iconSaveButton != null)
            builder.iconSaveButton.onClick.AddListener(SaveIcon);
    }

    // ==========================================================
    // üß© --- NPC ---
    // ==========================================================
    void OnGenerateDialogueClicked()
    {
        Debug.Log("üß© [UI] –ö–Ω–æ–ø–∫–∞ '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥' –Ω–∞–∂–∞—Ç–∞");

        string name = builder.npcNameField.text;
        string environment = builder.npcEnvironmentField.text;
        string relation = builder.npcRelationDropdown.options[builder.npcRelationDropdown.value].text;
        string emotion = builder.npcEmotionDropdown.options[builder.npcEmotionDropdown.value].text;
        string reaction = builder.npcReactionField.text;

        string inputJson = $@"{{
            ""playerAction"": ""interact"",
            ""npcName"": ""{name}"",
            ""npcState"": ""{relation}"",
            ""context"": {{
                ""location"": ""{environment}"",
                ""relationship"": ""{relation}""
            }},
            ""emotion"": ""{emotion}"",
            ""reactionLevel"": {reaction}
        }}";

        Debug.Log($"üì§ [UI] JSON –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ LLMPrototypeController:\n{inputJson}");

        onGenerateDialogue?.Invoke(inputJson);
        controller.ProcessJsonInput(inputJson);
    }

    void SaveNPCDialogue()
    {
        string text = builder.npcDialogueText.text;
        if (string.IsNullOrEmpty(text))
        {
            Debug.LogWarning("‚ö†Ô∏è –ù–µ—Ç –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
            return;
        }

        string folder = Path.Combine(Application.dataPath, "Exports/NPCDialogues");
        Directory.CreateDirectory(folder);

        string filename = Path.Combine(folder, $"dialogue_{DateTime.Now:yyyyMMdd_HHmmss}.txt");
        File.WriteAllText(filename, text);

        Debug.Log($"üíæ –î–∏–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {filename}");
        builder.npcDialogueText.text = $"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {Path.GetFileName(filename)}";
    }

    // ==========================================================
    // üìñ --- StoryTeller ---
    // ==========================================================
    void OnGenerateStoryClicked()
    {
        string theme = builder.storyThemeField.text;
        string style = builder.storyStyleDropdown.options[builder.storyStyleDropdown.value].text;
        string length = builder.storyLengthField.text;
        string questType = builder.questTypeDropdown.options[builder.questTypeDropdown.value].text;

        string inputJson = $@"{{
    ""storyTheme"": ""{theme}"",
    ""storyStyle"": ""{style}"",
    ""questType"": ""{questType}"",
    ""length"": ""{length}""
    }}";

        Debug.Log($"üì§ [UI] JSON –¥–ª—è –°–∫–∞–∑–∏—Ç–µ–ª—è –∏—Å—Ç–æ—Ä–∏–π:\n{inputJson}");
        onGenerateStory?.Invoke(inputJson);
        controller.ProcessJsonInput(inputJson);

        ShowLoading($"üìö –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ ({theme})...");

        controller.ProcessJsonInput(inputJson);
    }

    void SaveStory()
    {
        string text = builder.storyOutputText.text;
        if (string.IsNullOrEmpty(text))
        {
            Debug.LogWarning("‚ö†Ô∏è –ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
            return;
        }

        string folder = Path.Combine(Application.dataPath, "Exports/Stories");
        Directory.CreateDirectory(folder);

        string filename = Path.Combine(folder, $"story_{DateTime.Now:yyyyMMdd_HHmmss}.txt");
        File.WriteAllText(filename, text);

        Debug.Log($"üíæ –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {filename}");
        builder.storyOutputText.text = $"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {Path.GetFileName(filename)}";
    }

    // ==========================================================
    // üé® --- Icon Generator ---
    // ==========================================================
    void OnGenerateIconClicked()
    {
        Debug.Log("üé® [UI] –ö–Ω–æ–ø–∫–∞ '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∫–æ–Ω–∫—É' –Ω–∞–∂–∞—Ç–∞");

        string description = builder.iconDescriptionField.text;
        string style = builder.iconStyleDropdown.options[builder.iconStyleDropdown.value].text;
        string size = builder.iconSizeField.text;

        string inputJson = $@"{{
            ""iconDescription"": ""{description}"",
            ""iconStyle"": ""{style}"",
            ""iconSize"": ""{size}""
        }}";

        Debug.Log($"üì§ [UI] JSON –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ LLMPrototypeController:\n{inputJson}");

        onGenerateIcon?.Invoke(inputJson);
        controller.ProcessJsonInput(inputJson);
    }

    void SaveIcon()
    {
        string text = builder.iconStatusText.text;
        if (string.IsNullOrEmpty(text))
        {
            Debug.LogWarning("‚ö†Ô∏è –ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
            return;
        }

        string folder = Path.Combine(Application.dataPath, "Exports/Icons");
        Directory.CreateDirectory(folder);

        string filename = Path.Combine(folder, $"icon_{DateTime.Now:yyyyMMdd_HHmmss}.txt");
        File.WriteAllText(filename, text);

        Debug.Log($"üíæ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–∫–æ–Ω–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {filename}");
        builder.iconStatusText.text = $"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {Path.GetFileName(filename)}";
    }

    // ==========================================================
    // üîπ –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    // ==========================================================
    public void DisplayResult(string text)
    {
        if (builder.npcDialogueText != null && builder.npcPanel.activeSelf)
            builder.npcDialogueText.text = text;

        if (builder.storyOutputText != null && builder.storyTellerPanel.activeSelf)
            builder.storyOutputText.text = text;

        if (builder.iconStatusText != null && builder.iconGeneratorPanel.activeSelf)
            builder.iconStatusText.text = text;
    }
}
