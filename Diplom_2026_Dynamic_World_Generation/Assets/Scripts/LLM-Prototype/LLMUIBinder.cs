using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System;

public class LLMUIBinder : MonoBehaviour
{
    [Header("–û—Å–Ω–æ–≤–Ω—ã–µ —Å–≤—è–∑–∏")]
    public UIDynamicBuilder builder;
    public LLMPrototypeController controller;

    // === –°–æ–±—ã—Ç–∏—è ===
    public Action<string> onGenerateDialogue; // NPC
    public Action<string> onGenerateStory;    // –°–∫–∞–∑–∏—Ç–µ–ª—å –∏—Å—Ç–æ—Ä–∏–π
    public Action<string> onGenerateIcon;     // –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∫–æ–Ω

    void Start()
    {
        // === –ü—Ä–∏–≤—è–∑–∫–∏ ===
        if (builder == null) builder = FindObjectOfType<UIDynamicBuilder>();
        if (controller == null) controller = FindObjectOfType<LLMPrototypeController>();

        if (builder == null || controller == null)
        {
            Debug.LogError("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω UIDynamicBuilder –∏–ª–∏ LLMPrototypeController!");
            return;
        }

        BindUI();
    }

    public void BindUI()
    {
        // --- NPC –ü–∞–Ω–µ–ª—å ---
        if (builder.npcGenerateButton != null)
            builder.npcGenerateButton.onClick.AddListener(OnGenerateDialogueClicked);

        // --- –°–∫–∞–∑–∏—Ç–µ–ª—å –∏—Å—Ç–æ—Ä–∏–π ---
        if (builder.storyGenerateButton != null)
            builder.storyGenerateButton.onClick.AddListener(OnGenerateStoryClicked);

        // --- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∫–æ–Ω ---
        if (builder.iconGenerateButton != null)
            builder.iconGenerateButton.onClick.AddListener(OnGenerateIconClicked);
    }

    // ==========================================================
    // üß© --- –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä NPC ---
    // ==========================================================
    void OnGenerateDialogueClicked()
    {
        string name = builder.npcNameField.text;
        string relation = builder.npcRelationDropdown.options[builder.npcRelationDropdown.value].text;
        string emotion = builder.npcEmotionDropdown.options[builder.npcEmotionDropdown.value].text;
        string reaction = builder.npcReactionField.text;

        string inputJson = $@"{{
    ""playerAction"": ""interact"",
    ""npcState"": ""{relation}"",
    ""context"": {{
        ""location"": ""tavern"",
        ""relationship"": ""{relation}""
    }},
    ""emotion"": ""{emotion}"",
    ""reactionLevel"": {reaction}
}}";

        Debug.Log($"üì§ [UI] JSON –¥–ª—è NPC:\n{inputJson}");
        onGenerateDialogue?.Invoke(inputJson);
        controller.ProcessJsonInput(inputJson);
    }

    // ==========================================================
    // üìñ --- –°–∫–∞–∑–∏—Ç–µ–ª—å –∏—Å—Ç–æ—Ä–∏–π ---
    // ==========================================================
    void OnGenerateStoryClicked()
    {
        string theme = builder.storyThemeField.text;
        string style = builder.storyStyleDropdown.options[builder.storyStyleDropdown.value].text;
        string length = builder.storyLengthField.text;

        string inputJson = $@"{{
    ""storyTheme"": ""{theme}"",
    ""storyStyle"": ""{style}"",
    ""length"": ""{length}""
}}";

        Debug.Log($"üì§ [UI] JSON –¥–ª—è –°–∫–∞–∑–∏—Ç–µ–ª—è –∏—Å—Ç–æ—Ä–∏–π:\n{inputJson}");
        onGenerateStory?.Invoke(inputJson);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ LLM
        controller.ProcessJsonInput(inputJson);

        // --- Storyteller (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏) ---
        builder.storyGenerateButton.onClick.AddListener(() =>
        {
            var storyTheme = builder.storyThemeField.text;
            var storyStyle = builder.storyStyleDropdown.options[builder.storyStyleDropdown.value].text;
            var storyLength = builder.storyLengthField.text;

            string jsonInput = $@"
            {{
                ""mode"": ""story_generation"",
                ""theme"": ""{storyTheme}"",
                ""style"": ""{storyStyle}"",
                ""length"": ""{storyLength}""
            }}";

            Debug.Log($"[StoryTeller] –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –≤ LLM: {jsonInput}");
            controller.ProcessJsonInput(jsonInput);
        });

    }

    // ==========================================================
    // üé® --- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∫–æ–Ω ---
    // ==========================================================
    void OnGenerateIconClicked()
    {
        string description = builder.iconDescriptionField.text;
        string style = builder.iconStyleDropdown.options[builder.iconStyleDropdown.value].text;
        string size = builder.iconSizeField.text;

        string inputJson = $@"{{
    ""iconDescription"": ""{description}"",
    ""iconStyle"": ""{style}"",
    ""iconSize"": ""{size}""
}}";

        Debug.Log($"üì§ [UI] JSON –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –∏–∫–æ–Ω:\n{inputJson}");
        onGenerateIcon?.Invoke(inputJson);

        controller.ProcessJsonInput(inputJson);
    }

    // ==========================================================
    // üîπ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –≤—ã–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–∞ UI
    // ==========================================================
    public void DisplayResult(string text)
    {
        if (builder.npcDialogueText != null && builder.npcPanel.activeSelf)
            builder.npcDialogueText.text = text;

        if (builder.storyOutputText != null && builder.storyTellerPanel.activeSelf)
            builder.storyOutputText.text = text;

        if (builder.iconStatusText != null && builder.iconGeneratorPanel.activeSelf)
            builder.iconStatusText.text = text;
    }
}
